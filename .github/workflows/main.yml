name: Mirror ai-reviewer (all refs, PoC)
on:
  schedule:
    - cron: "0 * * * *"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  mirror:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout workflow branch
        uses: actions/checkout@v4
        with:
          ref: workflows  # Your special branch with just workflows
          path: workflows-backup

      - name: Clone external repo as a mirror
        run: |
          set -e
          EXTERNAL_REPO_URL="https://github.com/agencyenterprise/ai-reviewer.git"
          rm -rf repo-mirror
          git clone --mirror "$EXTERNAL_REPO_URL" repo-mirror

      - name: Remove workflow files from ALL branches and tags
        run: |
          set -e
          cd repo-mirror
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git config user.name "github-actions[bot]"
          pip install git-filter-repo
          git filter-repo --path .github/workflows --invert-paths --force

      - name: Push mirror
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          INTERNAL_REPO: ${{ github.repository }}
        run: |
          set -e
          cd repo-mirror
          git remote add origin "https://x-access-token:${GITHUB_TOKEN}@github.com/${INTERNAL_REPO}.git"
          git push --mirror --force

      - name: Restore workflow branch
        run: |
          cd workflows-backup
          git push origin workflows --force
